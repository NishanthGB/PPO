<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PPO AI with ChatGPT</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
    .glass{background:rgba(255,255,255,0.95);backdrop-filter:blur(10px)}
    .recommendation-card{border-left:5px solid;transition:all 0.3s}
    .recommendation-card:hover{transform:translateY(-4px);box-shadow:0 20px 40px rgba(0,0,0,0.15)}
    .priority-critical{border-left-color:#dc2626}
    .priority-high{border-left-color:#f59e0b}
    .priority-medium{border-left-color:#3b82f6}
    .priority-low{border-left-color:#10b981}
    .spinner{border:4px solid #f3f4f6;border-top:4px solid #667eea;width:40px;height:40px;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header class="bg-black bg-opacity-30 backdrop-blur-md sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-6 py-4">
      <h1 class="text-white text-3xl font-bold">üéØ PPO AI + ChatGPT</h1>
      <p class="text-purple-200 text-sm">AI-Powered Product Page Optimization with Monday.com & OpenAI</p>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-6 py-8">
    <div class="glass rounded-2xl p-8 mb-8 shadow-2xl">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">‚öôÔ∏è Configuration</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">OpenAI API Key</label>
          <input type="password" id="openaiKey" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg bg-white" placeholder="sk-...">
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">üì± Select App</label>
          <select id="appSelect" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg bg-white">
            <option value="">-- Choose an App --</option>
            <option value="GA">GA - Growth Analytics</option>
            <option value="MT">MT - Marketing Tools</option>
            <option value="CC">CC - Content Creator</option>
            <option value="AI">AI - AI Assistant</option>
            <option value="CA">CA - Customer Analytics</option>
            <option value="DA">DA - Data Analytics</option>
            <option value="QR">QR - QR Code Scanner</option>
            <option value="AR">AR - Augmented Reality</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">üîç Analysis Type</label>
          <select id="analysisType" class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg bg-white">
            <option value="recent">Recent (Last 3-4)</option>
            <option value="all">All History</option>
          </select>
        </div>
        <div class="flex items-end">
          <button id="generateBtn" onclick="generateWithAI()" class="w-full bg-gradient-to-r from-purple-600 to-purple-700 text-white font-bold py-2 rounded-lg hover:scale-105 transition-transform">üöÄ Analyze with AI</button>
        </div>
      </div>
    </div>

    <div id="results" class="glass rounded-2xl p-12 text-center text-gray-500">üëà Fill config and click Analyze</div>
  </main>

  <script>
    const CONFIG = {
      BOARD_ID: '7499252419',
      MONDAY_API_KEY: 'eyJhbGciOiJIUzI1NiJ9.eyJ0aWQiOjUwMTc0MTMyNSwiYWFwIjoxMSwidWlkIjo2OTI2OTQwMiwiaWFkIjoiMjAyNS0wNC0wMVQwMDowMDowMC4wMDBaIiwicGVyIjoibWU6d3JpdGUiLCJhY3RpZCI6MTIzODA3NTQsInJnbiI6InVzZTEifQ.M_-uTTM59YqoB9c0Rqnfo7X8BffJC1XMGEc6gauLFfs',
      MONDAY_ENDPOINT: 'https://api.monday.com/v2'
    };

    function showLoading(msg) {
      document.getElementById('results').innerHTML = `<div class="glass rounded-2xl p-12 flex flex-col items-center gap-4"><div class="spinner"></div><p class="text-gray-700">${msg}</p></div>`;
    }

    function showError(msg) {
      document.getElementById('results').innerHTML = `<div class="glass rounded-2xl p-6 bg-red-50 border-l-4 border-red-600"><h3 class="text-red-800 font-bold mb-2">‚ùå Error</h3><p class="text-red-700">${msg}</p></div>`;
    }

    async function generateWithAI() {
      const openaiKey = document.getElementById('openaiKey').value;
      const app = document.getElementById('appSelect').value;
      
      if (!openaiKey || !app) {
        showError('Please enter OpenAI API Key and select an app');
        return;
      }
      
      showLoading('üîç Fetching data from Monday.com...');
      try {
        const boardData = await fetchFromMonday();
        showLoading('ü§ñ Analyzing with ChatGPT...');
        const analysis = analyzeData(app, boardData);
        const recommendations = await getAIRecommendations(openaiKey, app, analysis);
        displayResults(app, analysis, recommendations);
      } catch (e) {
        console.error(e);
        showError(e.message);
      }
    }

    async function fetchFromMonday() {
      const query = `{boards(ids:[${CONFIG.BOARD_ID}]){groups{title items_page(limit:500){items{name updated_at column_values{title text}}}}}}`;
      const res = await fetch(CONFIG.MONDAY_ENDPOINT, {
        method: 'POST',
        headers: {
          'Authorization': CONFIG.MONDAY_API_KEY,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({query})
      });
      
      if (!res.ok) throw new Error(`Monday API error: ${res.status}`);
      const data = await res.json();
      if (data.errors) throw new Error(data.errors[0].message);
      return data.data.boards[0];
    }

    function analyzeData(appCode, boardData) {
      const allItems = [];
      boardData.groups.forEach(group => {
        if (group.items_page?.items) {
          group.items_page.items.forEach(item => {
            if (item.name.toUpperCase().startsWith(appCode.toUpperCase())) {
              allItems.push({
                name: item.name,
                group: group.title,
                updated_at: new Date(item.updated_at),
                columns: item.column_values || []
              });
            }
          });
        }
      });
      
      allItems.sort((a, b) => b.updated_at - a.updated_at);
      
      return {
        appCode,
        totalItems: allItems.length,
        recentItems: allItems.slice(0, 5),
        itemNames: allItems.map(i => i.name),
        allData: JSON.stringify(allItems.slice(0, 10), null, 2)
      };
    }

    async function getAIRecommendations(apiKey, appCode, analysis) {
      const prompt = `Analyze this product optimization data for app '${appCode}' and provide specific, actionable recommendations:\n\nData:\n${analysis.allData}\n\nTotal Tests: ${analysis.totalItems}\n\nProvide 3-5 recommendations in JSON format with fields: title, description, priority(high/medium/low), expectedImpact(%). Make it concise and practical.`;
      
      try {
        const res = await fetch('https://api.openai.com/v1/chat/completions', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${apiKey}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'gpt-3.5-turbo',
            messages: [{role: 'user', content: prompt}],
            temperature: 0.7,
            max_tokens: 1500
          })
        });
        
        if (!res.ok) {
          const err = await res.json();
          throw new Error(err.error?.message || 'ChatGPT API error');
        }
        
        const data = await res.json();
        const content = data.choices[0].message.content;
        const jsonMatch = content.match(/\[\s*\{[\s\S]*\}\s*\]/);
        return jsonMatch ? JSON.parse(jsonMatch[0]) : [{
          title: 'Analysis Complete',
          description: content,
          priority: 'high',
          expectedImpact: '10-15%'
        }];
      } catch (e) {
        throw new Error('ChatGPT Error: ' + e.message);
      }
    }

    function displayResults(appCode, analysis, recommendations) {
      let html = `<div class="space-y-6"><div class="glass rounded-2xl p-6 border-l-4 border-blue-500"><h3 class="text-2xl font-bold mb-4">üìà Analysis Results for ${appCode}</h3><div class="grid grid-cols-2 md:grid-cols-3 gap-4"><div class="bg-gray-50 p-4 rounded"><p class="text-gray-600 text-sm">Total Tests</p><p class="text-3xl font-bold text-blue-600">${analysis.totalItems}</p></div><div class="bg-gray-50 p-4 rounded"><p class="text-gray-600 text-sm">Recent Items</p><p class="text-3xl font-bold text-purple-600">${analysis.recentItems.length}</p></div></div></div><div><h2 class="text-2xl font-bold text-white mb-4">ü§ñ AI Recommendations</h2>`;
      
      recommendations.forEach(rec => {
        const priorityClass = `priority-${rec.priority || 'medium'}`;
        html += `<div class="glass rounded-2xl p-6 recommendation-card ${priorityClass}"><h4 class="text-xl font-bold mb-2">${rec.title}</h4><p class="text-gray-700 mb-3">${rec.description}</p><div class="flex justify-between items-center"><span class="text-sm text-gray-600">Priority: ${rec.priority}</span><span class="text-green-600 font-bold">Impact: ${rec.expectedImpact}</span></div></div>`;
      });
      
      html += `</div></div>`;
      document.getElementById('results').innerHTML = html;
    }
  </script>
</body>
</html>
